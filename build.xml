<project name="mainp-ingenias" default="run" basedir="." >
	<import file="iaf-generated-build.xml" as="iafmavenbuild" />
	<property name="specfile" value="src/main/spec/specification.xml"/>

	<!--   Compiles code generated by a JADE Module  and tests it   -->

	<target name="clean" depends="getclasspathfrommaven">
		  <delete dir="src/main/javagensrc"/>
		  <delete dir="src/main/javapermsrc"/>
	</target>
	
	 <target name="compilemaven"  depends="getclasspathfrommaven">
	  <maven basedir="${pom.dir}" goal="compile" resultproperty="maven.build.result" options="-e -Dbuild.for.prod=false -Djavac.debug=true -Djavac.optimize=false"/>
         </target>


	<target name="cleangeneratedcode" depends="getclasspathfrommaven">
		  <input
		    message="All generated sources are going to be deleted from src/main/javagensrc, src/main/javapermsrc, src/test/javagensrc, and src/test/javapermsrc continue (y/n)?"
		    validargs="y,n"
		    addproperty="do.delete"
  />
  <condition property="do.continue">
    <or>
     <equals arg1="y" arg2="${do.delete}"/>
     <equals arg1="yes" arg2="${do.delete}"/>
   </or>
  </condition>
  <fail unless="do.continue">Build aborted by user.</fail>
  <delete includeEmptyDirs="true">
    <fileset dir="src/main/javagensrc" includes="**/*"/>
    <fileset dir="src/main/javapermsrc" includes="**/*"/>
    <fileset dir="src/test/javapermsrc" includes="**/*"/>
    <fileset dir="src/test/javagensrc" includes="**/*"/>
  </delete>
  
	</target>

	<target name="edit" depends="getclasspathfrommaven">
		<java fork="true" failonerror="true" maxmemory="512m"
    classname="ingenias.editor.IDE">
			<jvmarg value="-Xmx1024m"/>
			<arg line="${specfile}"/>
			<classpath>
				<pathelement path="${ingeniasmavenclasspath}" />
				<pathelement path="${mavenclasspath}" />
				<pathelement path="${maven.build.outputDir}" />
			</classpath>
		</java>
	</target>

	<!-- Specification uploading -->
	<target name="noneedverifyupdatedspec" unless="temp.spec.present">
		<echo message="Your specification does not need to be updated. No changes were detected in the src/main/javagensrc folder"/>
	</target>

	<target name="verifyupdatedspec" if="temp.spec.present">
		<!-- verify the generation works and does not destroys code-->
		<delete dir="target/tmp/javagensrc"/>
		<mkdir dir="target/tmp/javagensrc"/>
		<mkdir dir="target/classes"/>
		<java failonerror="true" maxmemory="128m"
    classname="ingenias.codeproc.IAFGenerator">
			<arg line="${specfile}.idkbak . target/tmp/javagensrc target/tmp/javapermsrc true"/>
			<classpath>
				<pathelement path="${ingeniasmavenclasspath}" />
				<pathelement path="${mavenclasspath}" />
				<pathelement path="${maven.build.outputDir}" />
			</classpath>
		</java>
		<!-- check that it compiles-->
		<javac destdir="${maven.build.outputDir}" 
           nowarn="false" 
           debug="true" 
           optimize="false" 
           deprecation="true" 
           target="1.6" 
           verbose="false" 
           fork="false" 
           source="1.6">
			<src>
				<pathelement location="${maven.build.srcDir.0}"/>
				<pathelement location="src/main/javapermsrc"/>
				<pathelement location="target/tmp/javagensrc"/>
			</src>
			<classpath>
				<pathelement path="${ingeniasmavenclasspath}" />
				<pathelement path="${mavenclasspath}" />
				<pathelement path="${maven.build.outputDir}" />
			</classpath>
		</javac>
		<!-- TODO: compare generated files in target/tmp/javagensrc against those stored in src/main/javagensrc -->
		<!-- replaces the original file because everything works fine-->
		<copy file="${specfile}.idkbak" tofile="${specfile}"/>
		<delete dir="target/tmp/javagensrc"/>
		<delete file="${specfile}.idkbak"/>
		 <!-- overwrites the spec to restore the consistence between javagensrc and the currently modified spec -->
		<antcall target="compileproject"/>
	</target>

	<target name="updatespec" depends="getclasspathfrommaven">
		<!-- uploads code to an specification-->
		<delete file="${specfile}.idkbak"/>
		<java fork="true" failonerror="true" maxmemory="128m"
    classname="ingenias.module.CodeUploader">
			<arg line="${specfile} src/main/javagensrc ${specfile}.idkbak"/>
			<classpath>
				<pathelement path="${ingeniasmavenclasspath}" />
				<pathelement path="${mavenclasspath}" />
				<pathelement path="${maven.build.outputDir}" />
			</classpath>
		</java>
		<!-- check there is a new spec, because if no changes are required, no new specs are produced -->
		<available file="${specfile}.idkbak" type="file" property="temp.spec.present"/>
		<antcall target="verifyupdatedspec"/>
		<antcall target="noneedverifyupdatedspec"/>
	</target>

	<target name="htmldoc" depends="getclasspathfrommaven">
		<java fork="true" failonerror="true" maxmemory="128m"
    classname="ingenias.codeproc.HTMLDocumentGenerator">
			<arg line="${specfile} target"/>
			<classpath>
				<pathelement path="${ingeniasmavenclasspath}" />
				<pathelement path="${mavenclasspath}" />
				<pathelement path="${maven.build.outputDir}" />
			</classpath>
		</java>
	</target>

</project>

